-- 巴巴托斯之赏
cbabatuositask = class("cbabatuositask",ctaskcontainer)

function cbabatuositask:init(conf)
	ctaskcontainer.init(self,conf)
end

function cbabatuositask:can_accept(taskid)
	if self:reachlimit() then
		return false,language.format("今天已经没有藏宝图的线索了,请明天再来")
	end
	return ctaskcontainer.can_accept(self,taskid)
end

function cbabatuositask:can_raisewar()
	local player = playermgr.getplayer(self.pid)
	local fighters,errmsg = player:getfighters()
	if table.isempty(fighters) then
		return false,errmsg
	end
	local needlv = self:getformdata("var").StartWarNeedLv
	for i,uid in ipairs(fighters) do
		local member = playermgr.getplayer(uid)
		if member.lv < needlv then
			return false,language.format("#<G>{1}#等级不足#<R>{2}#级",member:getname(),needlv)
		end
	end
	return true
end

function cbabatuositask:transwar(task,warid,pid)
	assert(pid == self.pid)
	local war = ctaskcontainer.transwar(self,task,warid,pid)
	local player = playermgr.getplayer(pid)
	if warid < 0 then
		local lv
		if player:teamstate() == TEAM_STATE_CAPTAIN then
			lv = player:team_avglv(TEAM_STATE_CAPTAIN_FOLLOW)
		else
			lv = player.lv
		end
		local fakedata = self:getformdata("fake")
		local data = fakedata[lv] or fakedata[#fakedata]
		warid = data.warids[-warid]
	end
	war.wardataid = warid
	war.wartype = WARTYPE.PVE_SHARE_TASK
	return war
end

function cbabatuositask:_transaward(awardid,lv)
	if awardid < 0 then
		local fakedata = self:getformdata("fake")
		local data = fakedata[lv] or fakedata[#fakedata]
		awardid = data.awardid
	end
	local awarddata = self:getformdata("award")
	local bonus = award.getaward(awarddata,awardid,function (i,data)
		return data.ratio
	end)
	bonus = award.mergebonus(bonus)
	bonus = deepcopy(bonus)
	return bonus
end

function cbabatuositask:transaward(task,awardid,pid)
	assert(pid == self.pid)
	local player = playermgr.getplayer(self.pid)
	local lv = player:team_avglv(TEAM_STATE_CAPTAIN_FOLLOW)
	local teamstate = player:teamstate()
	local bonus = self:_transaward(awardid,lv)
	if teamstate == TEAM_STATE_CAPTAIN then
		local captain_exp_adden = math.floor(bonus.exp * CAPTAIN_EXP_ADDEN)
		bonus.exp = bonus.exp + captain_exp_adden
	end
	return bonus
end

function cbabatuositask:nexttask(taskid,reason)
	local chinesename = self:getformdata("name")
	local donelimit = self:getdonelimit()
	local donecnt = self:getdonecnt()
	local leftcnt = math.min(0,donelimit - donecnt)
	if donecnt >= donelimit then
		openui.messagebox(self.pid,{
			type = MB_SHIMOSHILIAN_REACHLIMIT,
			title = language.format("宝图任务"),
			content = language.format("【{1}】今天已经没有藏宝图的线索了，请明天再来。 \n剩余次数：{2}/{3}",chinesename,leftcnt,donelimit),
			buttons = {
				openui.button(language.format("确认")),
			}
		})
		return
	end
	local next_taskid,errmsg
	if self._next_taskid then
		next_taskid = self._next_taskid
		self._next_taskid = nil
	else
		next_taskid,errmsg = ctaskcontainer.nexttask(self,taskid,reason)
	end
	return next_taskid,errmsg
end

function cbabatuositask:onwarend(war,result)
	ctaskcontainer.onwarend(self,war,result)
	if warmgr.iswin(result) then
		local player = playermgr.getplayer(self.pid)
		local flag = self:getflag("ratio")
		local flag2 = self:getflag("isget")
		local isget = player.today:query(flag2)
		local vardata = self:getformdata("var")
		if not isget then
			local ratio = player.today:query(flag)
			local task = self:gettask(war.taskid)
			if not ratio then
				local startdropitemratio = vardata.StartDropItemRatio
				player.today:set(flag,startdropitemratio)
				ratio = startdropitemratio
			end
			local maxdropitemratio = vardata.MaxDropItemRatio
			local n = math.random(1,maxdropitemratio)
			if n > ratio then
				local adddropitemratio = vardata.AddDropItemRatio
				ratio = ratio + adddropitemratio
				player.today:set(flag,ratio)
				net.msg.S2C.notify(self.pid,language.format("未掉落藏宝图，请继续寻找"))
				task.execute_result = TASK_SCRIPT_FAIL
				if self.pid ~= war.pid then
					local captain = playermgr.getplayer(war.pid)
					local task = captain.taskdb.barbatos:gettask(war.taskid)
					task.execute_result = TASK_SCRIPT_FAIL
					net.msg.S2C.notify(war.pid,language.format("{1}未掉落藏宝图，请继续寻找",player.name))
				end
			else
				local donelimit = self:getdonelimit()
				local donecnt = self:getdonecnt()
				player.today:set(flag2,1)
				local additembytype = vardata.AddItemId or 601001
				local additemnum = vardata.AddItemNum or 1
				local additembind = vardata.AddItemBind or 0
				player:additembytype(additembytype,additemnum,additembind,"babatuosi",true)
				net.msg.S2C.notify(self.pid,language.format("获得【藏宝图】*1,今天已获得藏宝图{1}/{2}",(donecnt + 1),donelimit))
				if self.pid ~= war.pid then
					task.state = TASK_STATE_FINISH
				end
			end
		end
	end
end

function cbabatuositask:onsubmittask(taskid)
	local player = playermgr.getplayer(self.pid)
	local flag = self:getflag("isget")
	player.today:delete(flag)
end

function cbabatuositask:onfivehourupdate()
	ctaskcontainer.onfivehourupdate(self)
	self.lasttaskid = nil
end

return cbabatuositask
