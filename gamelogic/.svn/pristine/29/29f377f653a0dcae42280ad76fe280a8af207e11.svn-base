--指引任务
czhiyintask = class("czhiyintask",ctaskcontainer)

function czhiyintask:init(conf)
	ctaskcontainer.init(self,conf)
end

function czhiyintask:onlogin(player)
	if player:query("logincnt") == 1 then
		local taskid = self:getformdata("var").FirstDefaultTask
		if self:can_accept(taskid) then
			self:accepttask(taskid)
		end
	end
	ctaskcontainer.onlogin(self,player)
end

function czhiyintask:can_execute(task)
	local player = playermgr.getplayer(self.pid)
	local changejobtaskid = self:getformdata("var").FinishTaskInChangeJob
	if (task.taskid == changejobtaskid) and (player.roletype == 10001) then
		return false,language.format("请先完成转职任务")
	end
	return ctaskcontainer.can_execute(self,task)
end

function czhiyintask:choosetask(newtaskid,taskid)
	if newtaskid == "zhuxian" then
		local player = playermgr.getplayer(self.pid)
		local zhuxiantask = 10000101
		local isok,msg = player.taskdb.main:can_accept(zhuxiantask)
		if player.taskdb.main:can_accept(zhuxiantask) then
			player.taskdb.main:accepttask(zhuxiantask)
		end
		return
	end
	return ctaskcontainer.choosetask(self,newtaskid,taskid)
end

function czhiyintask:getcanaccept()
	local player = playermgr.getplayer(self.pid)
	if player.lv == 1 then
		return
	end
	for taskid,_ in pairs(self:getformdata("task")) do
		if not self.finishtasks[taskid] then
			local isok,msg = self:can_accept(taskid)
			if isok then
				self:accepttask(taskid)
			end
		end
	end
	return
end

return czhiyintask
