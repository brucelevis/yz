globalmgr = globalmgr or {}

function globalmgr.init()
	assert(not globalmgr.binit)
	globalmgr.binit = true
	globalmgr.id = 0
	globalmgr.id_allocto = {}	-- {srvname = {分配给该服务器的各个ID段}}
	local server = cserver.new()
	server:loadfromdatabase()
	server:add("runno",1)
	if server:query("runno") == 1 then
		server:create()
	end
	globalmgr.server = server

	local votemgr = cvotemgr.new()
	globalmgr.votemgr = votemgr

	local globalshopdb = cglobalshopdb.new()
	globalshopdb:loadfromdatabase()
	globalmgr.shop = globalshopdb

	globalmgr.rank = {}
	local arenarank = carenarank.new()
	arenarank:loadfromdatabase()
	globalmgr.rank.arena = arenarank
end

function globalmgr.onlogin(player)
	for i,ranks in pairs(globalmgr.rank) do
		if ranks.onlogin then
			ranks:onlogin(player)
		end
	end
end

function globalmgr.onlogoff(player,reason)
	for i,ranks in pairs(globalmgr.rank) do
		if ranks.onlogoff then
			ranks:onlogoff(player,reason)
		end
	end
end

function globalmgr.onhourupdate()
end

function globalmgr.onfivehourupdate()
	globalmgr.shop:onfivehourupdate()
	for i,ranks in pairs(globalmgr.rank) do
		if ranks.onfivehourupdate then
			ranks:onfivehourupdate()
		end
	end
end

function globalmgr.genid(fromsrv)
	--可用范围: (startid,endid]
	local startid = globalmgr.id
	globalmgr.id = globalmgr.id + 10000
	local endid = globalmgr.id
	if globalmgr.id_allocto[fromsrv] then
		globalmgr.id_allocto[fromsrv] = {}
	end
	table.insert(globalmgr.id_allocto[fromsrv],{startid,endid})
	return startid,endid
end

function globalmgr.fromsrv(id)
	for srvname,list in pairs(globalmgr.id_allocto) do
		for i,range in ipairs(list) do
			if range[1] < id and id <= range[2] then
				return srvname
			end
		end
	end
end

return globalmgr
